<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>üéÉ Halloween Nail Try-On!</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      touch-action: none;
    }
    body {
      background: #0f0c29;
      background: linear-gradient(to right, #24243e, #302b63, #0f0c29);
      overflow: hidden;
      font-family: 'Arial', 'Comic Sans MS', cursive, sans-serif; /* –ü–æ–∫—Ä–∞—â–µ–Ω–Ω—è: fallback –Ω–∞ –¥–æ—Å—Ç—É–ø–Ω—ñ—à–∏–π —à—Ä–∏—Ñ—Ç */
      color: white;
    }
    #video, #canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    #canvas {
      z-index: 10;
    }

    /* –ö–Ω–æ–ø–∫–∞ –º–æ–≤–∏ ‚Äî –≤–µ—Ä—Ö–Ω—ñ–π –ø—Ä–∞–≤–∏–π –∫—É—Ç */
    #langBtn {
      position: fixed;
      top: 16px;
      right: 16px;
      width: 48px; /* –ü–æ–∫—Ä–∞—â–µ–Ω–Ω—è: –∑–±—ñ–ª—å—à–µ–Ω–æ —Ä–æ–∑–º—ñ—Ä –¥–ª—è –∫—Ä–∞—â–æ–≥–æ —Ç–∞—á */
      height: 48px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(5px);
      border: 2px solid white;
      color: white;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 100;
      font-weight: bold;
      transition: transform 0.2s; /* –ü–æ–∫—Ä–∞—â–µ–Ω–Ω—è: –∞–Ω—ñ–º–∞—Ü—ñ—è –¥–ª—è –∑–≤–æ—Ä–æ—Ç–Ω–æ–≥–æ –∑–≤'—è–∑–∫—É */
    }
    #langBtn:hover {
      transform: scale(1.1);
    }

    /* –ó–≤—É–∫–æ–≤–∞ –∫–Ω–æ–ø–∫–∞ ‚Äî –≤–≥–æ—Ä—ñ –ø–æ —Ü–µ–Ω—Ç—Ä—É */
    #soundBtn {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(5px);
      border: 2px solid white;
      color: white;
      font-size: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 100;
      transition: transform 0.2s;
    }
    #soundBtn:hover {
      transform: scale(1.1);
    }

    /* –ö–Ω–æ–ø–∫–∏ —Ä–µ–∂–∏–º—É */
    #modeControls {
      position: fixed;
      top: 90px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 12px;
      z-index: 100;
    }
    .mode-btn {
      padding: 8px 16px;
      border-radius: 20px;
      background: #ff6b6b;
      color: white;
      border: none;
      font-weight: bold;
      font-size: 14px;
      cursor: pointer;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
      transition: transform 0.2s;
    }
    .mode-btn:hover {
      transform: scale(1.05);
    }
    .mode-btn.active {
      background: #ff4757;
      animation: pulse 1.5s infinite;
    }

    /* –î–∏–∑–∞–π–Ω–∏ ‚Äî –≤–Ω–∏–∑—É */
    #designPicker {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 14px;
      z-index: 100;
    }
    .design-btn {
      width: 64px;
      height: 64px;
      border-radius: 18px;
      border: 3px solid white;
      box-shadow: 0 4px 10px rgba(0,0,0,0.4);
      background: white;
      cursor: pointer;
      transition: transform 0.2s;
    }
    .design-btn:hover, .design-btn.selected {
      transform: scale(1.1);
      box-shadow: 0 0 0 4px gold;
    }

    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(255, 71, 87, 0.7); }
      70% { box-shadow: 0 0 0 12px rgba(255, 71, 87, 0); }
      100% { box-shadow: 0 0 0 0 rgba(255, 71, 87, 0); }
    }

    #loading {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.9);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      color: orange;
      font-size: 20px;
      text-align: center;
      padding: 20px;
    }
    #loading p {
      margin-top: 20px;
      color: white;
      font-size: 16px;
    }

    #errorRetry {
      margin-top: 20px;
      padding: 10px 20px;
      background: #ff4757;
      border: none;
      color: white;
      font-size: 16px;
      cursor: pointer;
      border-radius: 10px;
    }

    #cameraIndicator {
      position: fixed;
      top: 70px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 14px;
      color: lime;
      z-index: 100;
      display: none;
    }
  </style>
</head>
<body>
  <div id="loading">
    üéÉ Loading Halloween Nail Try-On...
    <p>Please allow camera access when prompted</p>
  </div>

  <video id="video" playsinline muted style="display:none"></video>
  <canvas id="canvas"></canvas>

  <div id="langBtn" aria-label="Switch language">EN</div>
  <div id="soundBtn" aria-label="Toggle sound">üîä</div>

  <div id="modeControls">
    <button class="mode-btn active" id="applyAllBtn" aria-label="Apply to all fingers">üíÖ All Fingers</button>
    <button class="mode-btn" id="selectFingerBtn" aria-label="Select a finger">üëÜ Pick Finger</button>
  </div>

  <div id="designPicker"></div>
  <div id="cameraIndicator">üìπ Camera Active</div>

  <script type="module">
    // –Ü–º–ø–æ—Ä—Ç MediaPipe
    import { HandLandmarker, FilesetResolver } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/+esm";

    // === –ü–µ—Ä–µ–∫–ª–∞–¥–∏ ===
    const translations = {
      en: {
        title: "üéÉ Halloween Nail Try-On!",
        loading: "üéÉ Loading Halloween Nail Try-On...",
        cameraPrompt: "Please allow camera access when prompted",
        allFingers: "üíÖ All Fingers",
        pickFinger: "üëÜ Pick Finger",
        cameraError: "‚ùå Could not access camera.<br>Try Chrome or Safari.",
        arError: "‚ùå AR failed to load.<br>Refresh the page.",
        retry: "Retry"
      },
      uk: {
        title: "üéÉ –ú–∞–Ω—ñ–∫—é—Ä –Ω–∞ –ì–µ–ª–ª–æ–≤—ñ–Ω!",
        loading: "üéÉ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ì–µ–ª–ª–æ–≤—ñ–Ω—Å—å–∫–æ–≥–æ –º–∞–Ω—ñ–∫—é—Ä—É...",
        cameraPrompt: "–ù–∞–¥–∞–π—Ç–µ –¥–æ—Å—Ç—É–ø –¥–æ –∫–∞–º–µ—Ä–∏, –∫–æ–ª–∏ –∑'—è–≤–∏—Ç—å—Å—è –∑–∞–ø–∏—Ç",
        allFingers: "üíÖ –£—Å—ñ –ø–∞–ª—å—Ü—ñ",
        pickFinger: "üëÜ –û–±—Ä–∞—Ç–∏ –ø–∞–ª–µ—Ü—å",
        cameraError: "‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ –¥–æ—Å—Ç—É–ø –¥–æ –∫–∞–º–µ—Ä–∏.<br>–°–ø—Ä–æ–±—É–π—Ç–µ —É Chrome –∞–±–æ Safari.",
        arError: "‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è AR.<br>–°–ø—Ä–æ–±—É–π—Ç–µ –æ–Ω–æ–≤–∏—Ç–∏ —Å—Ç–æ—Ä—ñ–Ω–∫—É.",
        retry: "–ü–æ–≤—Ç–æ—Ä–∏—Ç–∏"
      }
    };

    // === –ú–æ–≤–∞ ===
    let currentLang = localStorage.getItem('lang') || 'en';
    if (!['en', 'uk'].includes(currentLang)) currentLang = 'en'; // –ü–æ–∫—Ä–∞—â–µ–Ω–Ω—è: –≤–∞–ª—ñ–¥–∞—Ü—ñ—è localStorage
    document.documentElement.lang = currentLang;
    document.title = translations[currentLang].title;

    // === DOM ===
    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    const loading = document.getElementById("loading");
    const langBtn = document.getElementById("langBtn");
    const soundBtn = document.getElementById("soundBtn");
    const applyAllBtn = document.getElementById("applyAllBtn");
    const selectFingerBtn = document.getElementById("selectFingerBtn");
    const designPicker = document.getElementById("designPicker");
    const cameraIndicator = document.getElementById("cameraIndicator");

    // === –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Ç–µ–∫—Å—Ç—ñ–≤ ===
    function updateTexts() {
      document.title = translations[currentLang].title;
      langBtn.textContent = currentLang.toUpperCase();
      langBtn.setAttribute('aria-label', currentLang === 'en' ? 'Switch to Ukrainian' : 'Switch to English');
      
      loading.innerHTML = `
        üéÉ ${translations[currentLang].loading}
        <p>${translations[currentLang].cameraPrompt}</p>
      `;
      
      applyAllBtn.textContent = translations[currentLang].allFingers;
      selectFingerBtn.textContent = translations[currentLang].pickFinger;
    }

    // === –ü–µ—Ä–µ–º–∏–∫–∞—á –º–æ–≤–∏ ===
    langBtn.onclick = () => {
      currentLang = currentLang === 'en' ? 'uk' : 'en';
      localStorage.setItem('lang', currentLang);
      document.documentElement.lang = currentLang;
      updateTexts();
    };

    // === –ó–º—ñ–Ω–Ω—ñ –¥–æ–¥–∞—Ç–∫—É ===
    const DESIGNS = ["1", "2", "3", "4", "5", "6", "7", "8", "9", "10"];
    let currentDesign = "1";
    let nailImages = {};
    let isApplyAll = true;
    let selectedFingerIndex = -1;
    let isMuted = false;
    let bgAudio, clickAudio;
    let lastLandmarks = null; // –ü–æ–∫—Ä–∞—â–µ–Ω–Ω—è: –ª–æ–∫–∞–ª—å–Ω–∞ –∑–º—ñ–Ω–Ω–∞ –∑–∞–º—ñ—Å—Ç—å window
    let needsRedraw = true; // –ü–æ–∫—Ä–∞—â–µ–Ω–Ω—è: —Ñ–ª–∞–≥ –¥–ª—è –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—ó —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥—É

    function initAudio() {
      bgAudio = new Audio("audio/bg-music.mp3");
      clickAudio = new Audio("audio/click.mp3");
      bgAudio.loop = true;
      bgAudio.volume = 0.3;
      clickAudio.volume = 0.6;
      if (!isMuted) bgAudio.play().catch(e => console.log("Audio autoplay blocked:", e));

      // –ü–æ–∫—Ä–∞—â–µ–Ω–Ω—è: –ø–∞—É–∑–∞ –∞—É–¥—ñ–æ –ø—Ä–∏ –≤—Ç—Ä–∞—Ç—ñ –≤–∏–¥–∏–º–æ—Å—Ç—ñ
      document.addEventListener('visibilitychange', () => {
        if (document.hidden && !isMuted) {
          bgAudio.pause();
        } else if (!document.hidden && !isMuted) {
          bgAudio.play().catch(() => {});
        }
      });
    }

    async function loadDesigns() {
      // –ü–æ–∫—Ä–∞—â–µ–Ω–Ω—è: Promise.all –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≤—Å—ñ—Ö –∑–æ–±—Ä–∞–∂–µ–Ω—å
      const promises = DESIGNS.map(name => new Promise((resolve, reject) => {
        const img = new Image();
        img.src = `nails/halloween/${name}.png`;
        img.onload = () => resolve({ name, img });
        img.onerror = () => reject(new Error(`Failed to load image: nails/halloween/${name}.png`));
      }));
      try {
        const loaded = await Promise.all(promises);
        nailImages = Object.fromEntries(loaded.map(({ name, img }) => [name, img]));
      } catch (e) {
        console.error(e);
        loading.innerHTML = `${translations[currentLang].arError}<br><button id="errorRetry">${translations[currentLang].retry}</button>`;
        document.getElementById('errorRetry').onclick = () => location.reload();
        throw e;
      }
    }

    function buildDesignUI() {
      designPicker.innerHTML = "";
      DESIGNS.forEach(name => {
        const btn = document.createElement("img");
        btn.src = `nails/halloween/${name}.png`;
        btn.className = "design-btn";
        btn.alt = `Nail design ${name}`; // –ü–æ–∫—Ä–∞—â–µ–Ω–Ω—è: alt –¥–ª—è –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—ñ
        if (name === currentDesign) btn.classList.add("selected");
        btn.onclick = () => {
          currentDesign = name;
          document.querySelectorAll(".design-btn").forEach(b => b.classList.remove("selected"));
          btn.classList.add("selected");
          needsRedraw = true; // –ü–æ–∫—Ä–∞—â–µ–Ω–Ω—è: –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥—É
          if (!isMuted) {
            clickAudio.currentTime = 0;
            clickAudio.play().catch(() => {});
          }
        };
        designPicker.appendChild(btn);
      });
    }

    applyAllBtn.onclick = () => {
      isApplyAll = true;
      selectedFingerIndex = -1;
      applyAllBtn.classList.add("active");
      selectFingerBtn.classList.remove("active");
      needsRedraw = true;
    };
    
    selectFingerBtn.onclick = () => {
      isApplyAll = false;
      applyAllBtn.classList.remove("active");
      selectFingerBtn.classList.add("active");
      needsRedraw = true;
    };

    soundBtn.onclick = () => {
      isMuted = !isMuted;
      soundBtn.textContent = isMuted ? "üîá" : "üéµ";
      soundBtn.setAttribute('aria-label', isMuted ? 'Unmute sound' : 'Mute sound');
      if (isMuted) {
        bgAudio.pause();
      } else {
        bgAudio.play().catch(() => {});
      }
    };

    async function setupCamera() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { 
            facingMode: "environment",
            width: { ideal: 1280 },
            height: { ideal: 720 }
          }
        });
        video.srcObject = stream;
        cameraIndicator.style.display = 'block'; // –ü–æ–∫—Ä–∞—â–µ–Ω–Ω—è: —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä –∫–∞–º–µ—Ä–∏
        return new Promise(resolve => {
          video.onloadedmetadata = () => {
            video.play();
            resolve();
          };
        });
      } catch (e) {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({
            video: { 
              facingMode: "user",
              width: { ideal: 1280 },
              height: { ideal: 720 }
            }
          });
          video.srcObject = stream;
          cameraIndicator.style.display = 'block';
          return new Promise(resolve => {
            video.onloadedmetadata = () => {
              video.play();
              resolve();
            };
          });
        } catch (fallbackError) {
          loading.innerHTML = `${translations[currentLang].cameraError}<br><button id="errorRetry">${translations[currentLang].retry}</button>`;
          document.getElementById('errorRetry').onclick = setupCamera; // –ü–æ–∫—Ä–∞—â–µ–Ω–Ω—è: –∫–Ω–æ–ø–∫–∞ –ø–æ–≤—Ç–æ—Ä—É –¥–ª—è –∫–∞–º–µ—Ä–∏
          console.error("Camera error:", fallbackError);
          throw fallbackError;
        }
      }
    }

    function getClosestFinger(touchX, touchY, landmarks) {
      const fingerTips = [4, 8, 12, 16, 20];
      let minDist = Infinity;
      let closestIndex = -1;
      
      for (let i = 0; i < fingerTips.length; i++) {
        const lm = landmarks[fingerTips[i]];
        const x = lm.x * canvas.width;
        const y = lm.y * canvas.height;
        const dist = Math.hypot(touchX - x, touchY - y);
        
        if (dist < minDist && dist < canvas.width * 0.1) { // –ü–æ–∫—Ä–∞—â–µ–Ω–Ω—è: –¥–∏–Ω–∞–º—ñ—á–Ω–∏–π –ø–æ—Ä—ñ–≥ –Ω–∞ –æ—Å–Ω–æ–≤—ñ —Ä–æ–∑–º—ñ—Ä—É canvas
          minDist = dist;
          closestIndex = i;
        }
      }
      return closestIndex;
    }

    canvas.addEventListener("touchstart", e => {
      if (isApplyAll || !lastLandmarks) return;
      e.preventDefault();
      const touch = e.touches[0];
      const rect = canvas.getBoundingClientRect();
      const x = touch.clientX - rect.left;
      const y = touch.clientY - rect.top;
      selectedFingerIndex = getClosestFinger(x, y, lastLandmarks);
      needsRedraw = true; // –ü–æ–∫—Ä–∞—â–µ–Ω–Ω—è: –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥—É
    });

    function calculateNailSize(landmarks, fingerIndex) {
      // –ü–æ–∫—Ä–∞—â–µ–Ω–Ω—è: –¥–∏–Ω–∞–º—ñ—á–Ω–∏–π —Ä–æ–∑–º—ñ—Ä –Ω—ñ–≥—Ç—è –Ω–∞ –æ—Å–Ω–æ–≤—ñ –≤—ñ–¥—Å—Ç–∞–Ω—ñ –º—ñ–∂ –ª–µ–Ω–¥–º–∞—Ä–∫–∞–º–∏ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –∫—ñ–Ω—á–∏–∫ —ñ –æ—Å–Ω–æ–≤–∞ –ø–∞–ª—å—Ü—è)
      const fingerTips = [4, 8, 12, 16, 20];
      const fingerBases = [1, 5, 9, 13, 17]; // –ë–∞–∑–æ–≤—ñ –ª–µ–Ω–¥–º–∞—Ä–∫–∏ –¥–ª—è –ø–∞–ª—å—Ü—ñ–≤
      const tip = landmarks[fingerTips[fingerIndex]];
      const base = landmarks[fingerBases[fingerIndex]];
      const dist = Math.hypot((tip.x - base.x) * canvas.width, (tip.y - base.y) * canvas.height);
      return Math.max(40, dist * 0.8); // –ú—ñ–Ω—ñ–º–∞–ª—å–Ω–∏–π —Ä–æ–∑–º—ñ—Ä 40, –º–∞—Å—à—Ç–∞–±—É–≤–∞–Ω–Ω—è 80% –≤—ñ–¥—Å—Ç–∞–Ω—ñ
    }

    function renderAR(landmarks) {
      if (!needsRedraw) return; // –ü–æ–∫—Ä–∞—â–µ–Ω–Ω—è: —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Ç—ñ–ª—å–∫–∏ –ø—Ä–∏ –∑–º—ñ–Ω–∞—Ö
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.save();
      ctx.scale(-1, 1);
      ctx.translate(-canvas.width, 0);

      const fingerTips = [4, 8, 12, 16, 20];
      const img = nailImages[currentDesign];
      
      if (!img || !img.complete) return;

      for (let i = 0; i < fingerTips.length; i++) {
        // –Ø–∫—â–æ —Ä–µ–∂–∏–º –≤–∏–±–æ—Ä—É –ø–∞–ª—å—Ü—è —ñ —Ü–µ –Ω–µ –æ–±—Ä–∞–Ω–∏–π –ø–∞–ª–µ—Ü—å - –ø—Ä–æ–ø—É—Å–∫–∞—î–º–æ
        if (!isApplyAll && i !== selectedFingerIndex) continue;
        
        const lm = landmarks[fingerTips[i]];
        const x = lm.x * canvas.width;
        const y = lm.y * canvas.height;

        // –ü–æ–∫—Ä–∞—â–µ–Ω–Ω—è: –≤—ñ–∑—É–∞–ª—å–Ω–∏–π –∑–≤–æ—Ä–æ—Ç–Ω–∏–π –∑–≤'—è–∑–æ–∫ –¥–ª—è –æ–±—Ä–∞–Ω–æ–≥–æ –ø–∞–ª—å—Ü—è
        if (!isApplyAll && i === selectedFingerIndex) {
          ctx.beginPath();
          ctx.arc(x, y, 10, 0, 2 * Math.PI);
          ctx.strokeStyle = "yellow";
          ctx.lineWidth = 3;
          ctx.stroke();
        }

        const size = calculateNailSize(landmarks, i); // –ü–æ–∫—Ä–∞—â–µ–Ω–Ω—è: –¥–∏–Ω–∞–º—ñ—á–Ω–∏–π —Ä–æ–∑–º—ñ—Ä
        ctx.drawImage(img, x - size / 2, y - size / 4, size, size / 2);
      }

      ctx.restore();
      needsRedraw = false;
    }

    let handLandmarker;
    async function init() {
      try {
        // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è MediaPipe
        const vision = await FilesetResolver.forVisionTasks(
          "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/wasm"
        );
        
        handLandmarker = await HandLandmarker.createFromOptions(vision, {
          baseOptions: {
            modelAssetPath: "https://storage.googleapis.com/mediapipe-models/hand_landmarker/hand_landmarker/float16/1/hand_landmarker.task",
            delegate: "GPU"
          },
          runningMode: "VIDEO",
          numHands: 1
        });

        await setupCamera();
        
        // –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è —Ä–æ–∑–º—ñ—Ä—ñ–≤ canvas
        function updateCanvasSize() {
          const videoRatio = video.videoWidth / video.videoHeight;
          const windowRatio = window.innerWidth / window.innerHeight;
          if (windowRatio > videoRatio) {
            canvas.width = window.innerHeight * videoRatio;
            canvas.height = window.innerHeight;
          } else {
            canvas.width = window.innerWidth;
            canvas.height = window.innerWidth / videoRatio;
          }
          needsRedraw = true; // –ü–æ–∫—Ä–∞—â–µ–Ω–Ω—è: –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –ø—ñ—Å–ª—è –∑–º—ñ–Ω–∏ —Ä–æ–∑–º—ñ—Ä—É
        }

        // –ü–æ–∫—Ä–∞—â–µ–Ω–Ω—è: debounce –¥–ª—è resize
        let resizeTimeout;
        window.addEventListener("resize", () => {
          clearTimeout(resizeTimeout);
          resizeTimeout = setTimeout(updateCanvasSize, 100);
        });
        updateCanvasSize();

        // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ä–µ—Å—É—Ä—Å—ñ–≤
        await loadDesigns(); // –ü–æ–∫—Ä–∞—â–µ–Ω–Ω—è: await –¥–ª—è Promise.all
        buildDesignUI();
        initAudio();
        updateTexts();

        // –ü—Ä–∏—Ö–æ–≤—É–≤–∞–Ω–Ω—è –∑–∞–≤–∞–Ω—Ç–∞–∂—É–≤–∞—á–∞
        loading.style.display = "none";

        // –û—Å–Ω–æ–≤–Ω–∏–π —Ü–∏–∫–ª –≤—ñ–¥—Ç–≤–æ—Ä–µ–Ω–Ω—è
        let lastVideoTime = -1;
        
        const predict = () => {
          if (handLandmarker && video.readyState >= 2) {
            const currentTime = performance.now();
            
            // –û–±–º–µ–∂–µ–Ω–Ω—è —á–∞—Å—Ç–æ—Ç–∏ –æ–±—Ä–æ–±–∫–∏ –¥–ª—è –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ (–∫–æ–∂–Ω—ñ 100 –º—Å)
            if (currentTime - lastVideoTime > 100) {
              const predictions = handLandmarker.detectForVideo(video, currentTime);
              
              if (predictions.landmarks && predictions.landmarks.length > 0) {
                lastLandmarks = predictions.landmarks[0];
                renderAR(lastLandmarks);
              } else {
                if (needsRedraw) {
                  ctx.clearRect(0, 0, canvas.width, canvas.height);
                  needsRedraw = false;
                }
              }
              
              lastVideoTime = currentTime;
            }
          }
          requestAnimationFrame(predict);
        };
        
        predict();

        // –ü–æ–∫—Ä–∞—â–µ–Ω–Ω—è: –æ—á–∏—â–µ–Ω–Ω—è —Ä–µ—Å—É—Ä—Å—ñ–≤
        window.addEventListener("beforeunload", () => {
          if (video.srcObject) {
            video.srcObject.getTracks().forEach(track => track.stop());
          }
          if (handLandmarker) {
            handLandmarker.close();
          }
          cameraIndicator.style.display = 'none';
        });
      } catch (e) {
        console.error("Initialization error:", e);
        loading.innerHTML = `${translations[currentLang].arError}<br><button id="errorRetry">${translations[currentLang].retry}</button>`;
        document.getElementById('errorRetry').onclick = () => location.reload();
      }
    }

    // –ó–∞–ø—É—Å–∫ –¥–æ–¥–∞—Ç–∫—É
    window.addEventListener("load", init);
  </script>
</body>
</html>
