<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>üéÉ –ú–∞–Ω—ñ–∫—é—Ä –Ω–∞ –ì–µ–ª–ª–æ–≤—ñ–Ω!</title>
  <!-- –í–ò–ü–†–ê–í–õ–ï–ù–ù–Ø: –î–æ–¥–∞–Ω–æ data: URL favicon, —â–æ–± —É–Ω–∏–∫–Ω—É—Ç–∏ 404 -->
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üéÉ</text></svg>">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      touch-action: none;
    }
    body {
      background: #0f0c29;
      background: linear-gradient(to right, #24243e, #302b63, #0f0c29);
      overflow: hidden;
      font-family: 'Arial', 'Comic Sans MS', cursive, sans-serif;
      color: white;
    }
    #video, #canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      /* –í–ò–ü–†–ê–í–õ–ï–ù–ù–Ø: object-fit: cover –º–æ–∂–µ –æ–±—Ä—ñ–∑–∞—Ç–∏ –≤—ñ–¥–µ–æ, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ contain */
      object-fit: contain;
    }
    #video {
      z-index: 5;
      background: black; /* –í–ò–ü–†–ê–í–õ–ï–ù–ù–Ø: —á–æ—Ä–Ω–∏–π —Ñ–æ–Ω —è–∫—â–æ –≤—ñ–¥–µ–æ –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏–ª–æ—Å—å */
    }
    #canvas {
      z-index: 10;
      background: transparent;
    }

    /* ... —Ä–µ—à—Ç–∞ —Å—Ç–∏–ª—ñ–≤ –∑–∞–ª–∏—à–∞—î—Ç—å—Å—è –±–µ–∑ –∑–º—ñ–Ω ... */
    #langBtn {
      position: fixed;
      top: 16px;
      right: 16px;
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(5px);
      border: 2px solid white;
      color: white;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 100;
      font-weight: bold;
      transition: transform 0.2s;
    }
    #langBtn:hover { transform: scale(1.1); }

    #soundBtn {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(5px);
      border: 2px solid white;
      color: white;
      font-size: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 100;
      transition: transform 0.2s;
    }
    #soundBtn:hover { transform: scale(1.1); }

    #modeControls {
      position: fixed;
      top: 90px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 12px;
      z-index: 100;
    }
    .mode-btn {
      padding: 8px 16px;
      border-radius: 20px;
      background: #ff6b6b;
      color: white;
      border: none;
      font-weight: bold;
      font-size: 14px;
      cursor: pointer;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
      transition: transform 0.2s;
    }
    .mode-btn:hover { transform: scale(1.05); }
    .mode-btn.active {
      background: #ff4757;
      animation: pulse 1.5s infinite;
    }

    #designPicker {
      position: fixed;
      bottom: 20px;
      left: 0;
      width: 100%;
      display: flex;
      gap: 14px;
      z-index: 100;
      overflow-x: auto;
      white-space: nowrap;
      padding: 0 20px;
      box-sizing: border-box;
      scrollbar-width: thin;
      scrollbar-color: #ff4757 transparent;
    }
    .design-btn {
      width: 64px;
      height: 64px;
      border-radius: 18px;
      border: 3px solid white;
      box-shadow: 0 4px 10px rgba(0,0,0,0.4);
      background: white;
      cursor: pointer;
      transition: transform 0.2s;
      flex-shrink: 0;
    }
    .design-btn:hover, .design-btn.selected {
      transform: scale(1.1);
      box-shadow: 0 0 0 4px gold;
    }

    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(255, 71, 87, 0.7); }
      70% { box-shadow: 0 0 0 12px rgba(255, 71, 87, 0); }
      100% { box-shadow: 0 0 0 0 rgba(255, 71, 87, 0); }
    }

    #loading {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.9);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      color: orange;
      font-size: 20px;
      text-align: center;
      padding: 20px;
    }
    #loading p { margin-top: 20px; color: white; font-size: 16px; }

    #errorRetry {
      margin-top: 20px;
      padding: 10px 20px;
      background: #ff4757;
      border: none;
      color: white;
      font-size: 16px;
      cursor: pointer;
      border-radius: 10px;
    }

    #cameraIndicator, #handIndicator, #debugInfo {
      position: fixed;
      left: 10px;
      font-size: 12px;
      z-index: 100;
      background: rgba(0,0,0,0.7);
      padding: 5px;
      border-radius: 5px;
      display: none;
    }
    #cameraIndicator { top: 70px; color: lime; }
    #handIndicator { top: 100px; color: white; }
    #debugInfo { top: 130px; color: yellow; max-width: 300px; }
  </style>
</head>
<body>
  <div id="loading">
    üéÉ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ì–µ–ª–ª–æ–≤—ñ–Ω—Å—å–∫–æ–≥–æ –º–∞–Ω—ñ–∫—é—Ä—É...
    <p>–ù–∞–¥–∞–π—Ç–µ –¥–æ—Å—Ç—É–ø –¥–æ –∫–∞–º–µ—Ä–∏, –∫–æ–ª–∏ –∑'—è–≤–∏—Ç—å—Å—è –∑–∞–ø–∏—Ç</p>
  </div>

  <video id="video" playsinline muted></video>
  <canvas id="canvas"></canvas>

  <div id="langBtn" aria-label="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç–∏ –º–æ–≤—É">UK</div>
  <div id="soundBtn" aria-label="–£–≤—ñ–º–∫–Ω—É—Ç–∏/–≤–∏–º–∫–Ω—É—Ç–∏ –∑–≤—É–∫">üîä</div>

  <div id="modeControls">
    <button class="mode-btn active" id="applyAllBtn">üíÖ –£—Å—ñ –ø–∞–ª—å—Ü—ñ</button>
    <button class="mode-btn" id="selectFingerBtn">üëÜ –û–±—Ä–∞—Ç–∏ –ø–∞–ª–µ—Ü—å</button>
  </div>

  <div id="designPicker"></div>
  <div id="cameraIndicator">üìπ –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∫–∞–º–µ—Ä–∏...</div>
  <div id="handIndicator">‚úã –†—É–∫–∞ –Ω–µ –≤–∏—è–≤–ª–µ–Ω–∞</div>
  <div id="debugInfo">–î—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞: –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>

  <script type="module">
    import { HandLandmarker, FilesetResolver } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/+esm";

    const debugInfo = document.getElementById('debugInfo');
    const translations = {
      uk: {
        title: "üéÉ –ú–∞–Ω—ñ–∫—é—Ä –Ω–∞ –ì–µ–ª–ª–æ–≤—ñ–Ω!",
        loading: "üéÉ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ì–µ–ª–ª–æ–≤—ñ–Ω—Å—å–∫–æ–≥–æ –º–∞–Ω—ñ–∫—é—Ä—É...",
        cameraPrompt: "–ù–∞–¥–∞–π—Ç–µ –¥–æ—Å—Ç—É–ø –¥–æ –∫–∞–º–µ—Ä–∏, –∫–æ–ª–∏ –∑'—è–≤–∏—Ç—å—Å—è –∑–∞–ø–∏—Ç",
        allFingers: "üíÖ –£—Å—ñ –ø–∞–ª—å—Ü—ñ",
        pickFinger: "üëÜ –û–±—Ä–∞—Ç–∏ –ø–∞–ª–µ—Ü—å",
        cameraError: "‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ –¥–æ—Å—Ç—É–ø –¥–æ –∫–∞–º–µ—Ä–∏.<br>–°–ø—Ä–æ–±—É–π—Ç–µ —É Chrome –∞–±–æ Safari.",
        arError: "‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è AR.<br>–°–ø—Ä–æ–±—É–π—Ç–µ –æ–Ω–æ–≤–∏—Ç–∏ —Å—Ç–æ—Ä—ñ–Ω–∫—É.",
        retry: "–ü–æ–≤—Ç–æ—Ä–∏—Ç–∏",
        rearCamera: "üìπ –ó–∞–¥–Ω—è –∫–∞–º–µ—Ä–∞ –∞–∫—Ç–∏–≤–Ω–∞",
        frontCamera: "üìπ –ü–µ—Ä–µ–¥–Ω—è –∫–∞–º–µ—Ä–∞ –∞–∫—Ç–∏–≤–Ω–∞",
        handNotDetected: "‚úã –†—É–∫–∞ –Ω–µ –≤–∏—è–≤–ª–µ–Ω–∞",
        videoReady: "‚úÖ –í—ñ–¥–µ–æ –≥–æ—Ç–æ–≤–µ",
        landmarksDetected: "‚úÖ –í–∏—è–≤–ª–µ–Ω–æ —Ä—É–∫—É"
      }
    };

    let currentLang = 'uk';
    document.documentElement.lang = currentLang;
    document.title = translations[currentLang].title;

    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    const loading = document.getElementById("loading");
    const langBtn = document.getElementById("langBtn");
    const soundBtn = document.getElementById("soundBtn");
    const applyAllBtn = document.getElementById("applyAllBtn");
    const selectFingerBtn = document.getElementById("selectFingerBtn");
    const designPicker = document.getElementById("designPicker");
    const cameraIndicator = document.getElementById("cameraIndicator");
    const handIndicator = document.getElementById("handIndicator");

    // –î–Ü–ê–ì–ù–û–°–¢–ò–ö–ê: –õ–æ–≥—É–≤–∞–Ω–Ω—è —Å—Ç–∞–Ω—É –≤—ñ–¥–µ–æ
    video.addEventListener('loadedmetadata', () => {
      debugInfo.innerHTML += `<br>–í—ñ–¥–µ–æ: ${video.videoWidth}x${video.videoHeight}`;
      cameraIndicator.textContent = translations[currentLang].videoReady;
    });

    video.addEventListener('play', () => {
      debugInfo.innerHTML += `<br>–í—ñ–¥–µ–æ –≥—Ä–∞—î`;
    });

    function updateDebugInfo(message) {
      console.log('DEBUG:', message);
      debugInfo.innerHTML += `<br>${message}`;
      debugInfo.style.display = 'block';
    }

    const DESIGNS = ["1", "2", "3", "4", "5", "6", "7", "8", "9", "10"];
    let currentDesign = "1";
    let nailImages = {};
    let isApplyAll = true;
    let selectedFingerIndex = -1;
    let isMuted = false;
    let lastLandmarks = null;
    let smoothedLandmarks = null;
    const SMOOTHING_FACTOR = 0.5;
    let needsRedraw = true;
    let handLandmarker;

    async function loadDesigns() {
      updateDebugInfo('–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∏–∑–∞–π–Ω—ñ–≤...');
      const promises = DESIGNS.map(name => new Promise((resolve, reject) => {
        const img = new Image();
        img.src = `nails/halloween/${name}.png`;
        img.onload = () => {
          console.log(`–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ: ${name}.png`);
          resolve({ name, img });
        };
        img.onerror = () => {
          console.error(`–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è: nails/halloween/${name}.png`);
          // –í–ò–ü–†–ê–í–õ–ï–ù–ù–Ø: –°—Ç–≤–æ—Ä—é—î–º–æ –∑–∞–≥–ª—É—à–∫—É —è–∫—â–æ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏–ª–æ—Å—å
          const canvas = document.createElement('canvas');
          canvas.width = 64;
          canvas.height = 64;
          const ctx = canvas.getContext('2d');
          ctx.fillStyle = '#ff6b6b';
          ctx.fillRect(0, 0, 64, 64);
          ctx.fillStyle = 'white';
          ctx.font = '20px Arial';
          ctx.fillText(name, 20, 40);
          resolve({ name, img: canvas });
        };
      }));
      try {
        const loaded = await Promise.all(promises);
        nailImages = Object.fromEntries(loaded.map(({ name, img }) => [name, img]));
        updateDebugInfo(`–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ ${DESIGNS.length} –¥–∏–∑–∞–π–Ω—ñ–≤`);
      } catch (e) {
        console.error(e);
        throw e;
      }
    }

    function buildDesignUI() {
      designPicker.innerHTML = "";
      DESIGNS.forEach(name => {
        const btn = document.createElement("img");
        btn.src = nailImages[name] ? nailImages[name].src || 'data:image/png;base64,...' : `nails/halloween/${name}.png`;
        btn.className = "design-btn";
        btn.alt = `–î–∏–∑–∞–π–Ω –Ω—ñ–≥—Ç—ñ–≤ ${name}`;
        if (name === currentDesign) btn.classList.add("selected");
        btn.onclick = () => {
          currentDesign = name;
          document.querySelectorAll(".design-btn").forEach(b => b.classList.remove("selected"));
          btn.classList.add("selected");
          needsRedraw = true;
        };
        designPicker.appendChild(btn);
      });
      updateDebugInfo('UI –¥–∏–∑–∞–π–Ω—ñ–≤ –ø–æ–±—É–¥–æ–≤–∞–Ω–æ');
    }

    // ... —Ä–µ—à—Ç–∞ —Ñ—É–Ω–∫—Ü—ñ–π onclick –∑–∞–ª–∏—à–∞—î—Ç—å—Å—è –±–µ–∑ –∑–º—ñ–Ω ...

    applyAllBtn.onclick = () => {
      isApplyAll = true;
      selectedFingerIndex = -1;
      applyAllBtn.classList.add("active");
      selectFingerBtn.classList.remove("active");
      needsRedraw = true;
    };
    
    selectFingerBtn.onclick = () => {
      isApplyAll = false;
      applyAllBtn.classList.remove("active");
      selectFingerBtn.classList.add("active");
      needsRedraw = true;
    };

    async function setupCamera() {
      updateDebugInfo('–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∫–∞–º–µ—Ä–∏...');
      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { 
            facingMode: "environment",
            width: { ideal: 1280 },
            height: { ideal: 720 }
          }
        });
        video.srcObject = stream;
        cameraIndicator.style.display = 'block';
        
        // –í–ò–ü–†–ê–í–õ–ï–ù–ù–Ø: –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ç—Ä–µ–∫—ñ–≤ –≤—ñ–¥–µ–æ
        const videoTrack = stream.getVideoTracks()[0];
        console.log('Video track:', videoTrack);
        updateDebugInfo(`–ö–∞–º–µ—Ä–∞: ${videoTrack.label || '–Ω–µ–≤—ñ–¥–æ–º–æ'}`);
        
        return new Promise(resolve => {
          video.onloadedmetadata = () => {
            updateDebugInfo(`–í—ñ–¥–µ–æ —Ä–æ–∑–º—ñ—Ä: ${video.videoWidth}x${video.videoHeight}`);
            video.play();
            resolve();
          };
          video.onerror = (e) => {
            console.error('Video error:', e);
            updateDebugInfo('–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–µ–æ: ' + e.message);
            reject(e);
          };
        });
      } catch (e) {
        updateDebugInfo('–ó–∞–¥–Ω—è –∫–∞–º–µ—Ä–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞, –ø—Ä–æ–±—É—î–º–æ –ø–µ—Ä–µ–¥–Ω—é...');
        try {
          const stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: "user", width: { ideal: 1280 }, height: { ideal: 720 } }
          });
          video.srcObject = stream;
          cameraIndicator.style.display = 'block';
          updateDebugInfo('–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –ø–µ—Ä–µ–¥–Ω—è –∫–∞–º–µ—Ä–∞');
          return new Promise(resolve => {
            video.onloadedmetadata = () => {
              video.play();
              resolve();
            };
          });
        } catch (fallbackError) {
          updateDebugInfo('–ü–æ–º–∏–ª–∫–∞ –∫–∞–º–µ—Ä–∏: ' + fallbackError.message);
          loading.innerHTML = `${translations[currentLang].cameraError}<br><button id="errorRetry">${translations[currentLang].retry}</button>`;
          document.getElementById('errorRetry').onclick = setupCamera;
          throw fallbackError;
        }
      }
    }

    // –í–ò–ü–†–ê–í–õ–ï–ù–ù–Ø: –°–ø—Ä–æ—â–µ–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥—É –¥–ª—è —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è
    function renderAR(landmarks) {
      if (!needsRedraw) return;
      
      // –û—á–∏—â—É—î–º–æ —Ç—ñ–ª—å–∫–∏ AR —à–∞—Ä, –Ω–µ —á—ñ–ø–∞—î–º–æ –≤—ñ–¥–µ–æ
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      // –î–Ü–ê–ì–ù–û–°–¢–ò–ö–ê: –ú–∞–ª—é—î–º–æ —Ä–∞–º–∫—É —è–∫—â–æ –ª–µ–Ω–¥–º–∞—Ä–∫–∏ —î
      if (landmarks && landmarks.length > 0) {
        ctx.strokeStyle = 'lime';
        ctx.lineWidth = 2;
        ctx.strokeRect(10, 10, 100, 50);
        ctx.fillStyle = 'lime';
        ctx.font = '16px Arial';
        ctx.fillText('–†–£–ö–ê –í–ò–Ø–í–õ–ï–ù–ê', 15, 35);
      }
      
      ctx.save();
      ctx.scale(-1, 1);
      ctx.translate(-canvas.width, 0);

      const fingerTips = [4, 8, 12, 16, 20];
      const img = nailImages[currentDesign];
      
      if (img && landmarks) {
        for (let i = 0; i < fingerTips.length; i++) {
          if (!isApplyAll && i !== selectedFingerIndex) continue;
          
          const lm = landmarks[fingerTips[i]];
          if (!lm) continue;
          
          const x = lm.x * canvas.width;
          const y = lm.y * canvas.height;

          // –í–ò–ü–†–ê–í–õ–ï–ù–ù–Ø: –ü—Ä–æ—Å—Ç–∏–π —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ –±–µ–∑ —Å–∫–ª–∞–¥–Ω–æ—ó —Ä–æ—Ç–∞—Ü—ñ—ó –¥–ª—è —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è
          const size = 60;
          ctx.drawImage(img, x - size / 2, y - size / 4, size, size / 2);
          
          // –î–Ü–ê–ì–ù–û–°–¢–ò–ö–ê: –ü–æ–∫–∞–∑—É—î–º–æ —Ç–æ—á–∫–∏ –ø–∞–ª—å—Ü—ñ–≤
          ctx.fillStyle = 'red';
          ctx.beginPath();
          ctx.arc(x, y, 5, 0, 2 * Math.PI);
          ctx.fill();
        }
      }

      ctx.restore();
      needsRedraw = false;
    }

    function updateCanvasSize() {
      // –í–ò–ü–†–ê–í–õ–ï–ù–ù–Ø: –ü—Ä–æ—Å—Ç–µ –º–∞—Å—à—Ç–∞–±—É–≤–∞–Ω–Ω—è –±–µ–∑ —Å–∫–ª–∞–¥–Ω–æ—ó –ª–æ–≥—ñ–∫–∏
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
      video.width = window.innerWidth;
      video.height = window.innerHeight;
      updateDebugInfo(`Canvas: ${canvas.width}x${canvas.height}`);
      needsRedraw = true;
    }

    async function init() {
      updateDebugInfo('–Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è AR...');
      try {
        const vision = await FilesetResolver.forVisionTasks(
          "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/wasm"
        );
        updateDebugInfo('MediaPipe –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ');
        
        handLandmarker = await HandLandmarker.createFromOptions(vision, {
          baseOptions: {
            modelAssetPath: "https://storage.googleapis.com/mediapipe-models/hand_landmarker/hand_landmarker/float16/1/hand_landmarker.task",
            delegate: "GPU"
          },
          runningMode: "VIDEO",
          numHands: 1
        });
        updateDebugInfo('HandLandmarker –≥–æ—Ç–æ–≤–∏–π');

        await setupCamera();
        updateCanvasSize();

        await loadDesigns();
        buildDesignUI();
        loading.style.display = "none";
        cameraIndicator.style.display = 'block';
        updateDebugInfo('–Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞');

        // –û—Å–Ω–æ–≤–Ω–∏–π —Ü–∏–∫–ª
        let lastVideoTime = -1;
        const predict = () => {
          if (handLandmarker && video.readyState >= 2 && video.videoWidth > 0) {
            const currentTime = performance.now();
            if (currentTime - lastVideoTime > 100) {
              const predictions = handLandmarker.detectForVideo(video, currentTime);
              
              if (predictions.landmarks && predictions.landmarks.length > 0) {
                lastLandmarks = predictions.landmarks[0];
                handIndicator.style.display = 'none';
                renderAR(lastLandmarks);
                updateDebugInfo(`–õ–µ–Ω–¥–º–∞—Ä–∫—ñ–≤: ${lastLandmarks.length}`);
              } else {
                handIndicator.style.display = 'block';
                if (needsRedraw) {
                  ctx.clearRect(0, 0, canvas.width, canvas.height);
                  needsRedraw = false;
                }
              }
              lastVideoTime = currentTime;
            }
          }
          requestAnimationFrame(predict);
        };
        predict();

      } catch (e) {
        console.error("–ü–æ–º–∏–ª–∫–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó:", e);
        updateDebugInfo('–ü–û–ú–ò–õ–ö–ê: ' + e.message);
        loading.innerHTML = `${translations[currentLang].arError}<br><button id="errorRetry">${translations[currentLang].retry}</button>`;
        document.getElementById('errorRetry').onclick = () => location.reload();
      }
    }

    window.addEventListener("load", init);
    window.addEventListener("resize", updateCanvasSize);
  </script>
</body>
</html>
